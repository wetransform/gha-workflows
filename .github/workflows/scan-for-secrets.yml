name: Detect secrets with Gitleaks

on:
  workflow_call:
    secrets:
      SLACK_EXPOSED_SECRETS_WEBHOOK:
        required: true
#  push:
#    branches: ["**"]

env:
  REPORT_FILE: gitleaks-report.json

jobs:
  secret-scan:
    name: Run gitleaks secret scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          # fetch-depth=0 fetches full history so gitleaks can examine all commits
          fetch-depth: 0

      # Install gitleaks via mise
      - name: Install gitleaks via mise
        uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3.6.1
        with:
          version: 2026.2.20
          install: true
          install_args: "gitleaks" # only install tools needed for workflow
          cache: true
          tool_versions: |
            gitleaks 8.30.0

      # Run gitleaks against the current repository and save a JSON
      # report to gitleaks-report.json.
      - name: Run gitleaks scan
        id: gitleaks
        run: |
          set +e

          # Perform the scan on the git history
          gitleaks git \
            --report-format json \
            --report-path "${REPORT_FILE}" \
            --gitleaks-ignore-path . \
            --exit-code 1 \
            --redact \
            --verbose
          scan_exit_code=$?
          echo "exitcode=$scan_exit_code" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      - name: Upload report as artifact
        if: steps.gitleaks.outputs.exitcode != '0'
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: gitleaks-report
          path: "${{ env.REPORT_FILE }}"
          retention-days: 1 # all necessary information will be in the slack notification, so we can discard it

      - name: Fail if secrets were detected
        if: steps.gitleaks.outputs.exitcode != '0'
        run: |
          echo "Secrets were detected by gitleaks. Failing the workflow. $SLACK_MESSAGE"
          exit 1

  slack-notify:
    name: Notify on Slack if secrets were detected
    if: failure()
    runs-on: ubuntu-latest
    needs: secret-scan
    steps:
      - name: Download gitleaks report artifact
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8.0.0
        with:
          name: gitleaks-report

      # Build payload that lists all files + line numbers with secrets and links them
      - name: Build Slack payload
        id: build_slack
        run: |
          header="See"
          leaks=""
          # Loop over each finding in the report and append file/line information
          while IFS= read -r item; do
            link=$(echo "$item" | jq -r '.Link')
            file=$(echo "$item" | jq -r '.File')
            line=$(echo "$item" | jq -r '.StartLine')
            leaks="${leaks} â€¢ [${file}:${line}](${link})\n"
          done < <(jq -c '.[]' "$REPORT_FILE")
          message="${header}\n${leaks}"
          # Expose the message as an environment variable for the next step
          {
            echo 'SLACK_MESSAGE<<EOF'
            echo "$message"
            echo 'EOF'
          } >> "$GITHUB_ENV"

      - name: Send Slack alert
        uses: rtCamp/action-slack-notify@e31e87e03dd19038e411e38ae27cbad084a90661 # v2.3.3
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_EXPOSED_SECRETS_WEBHOOK }}
          SLACK_COLOR: danger
          SLACK_TITLE: "Gitleaks detected secrets in ${{ github.repository }}"
          SLACK_FOOTER: ""
          SLACKIFY_MARKDOWN: true
