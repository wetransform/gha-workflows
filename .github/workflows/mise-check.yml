#
# Mise check workflow
#
# Intended to be run for pull requests.
#
# Conventions:
# - workflow uses mise environment "ci"
# - should have a mise task named "ci:check"
#
# Variants:
# - npm: Cache Node.js modules
#

on:
  workflow_call:
    inputs:
      variant:
        description: Workflow variant to use (leave empty or use one of 'npm')
        required: true
        type: string
      parallel:
        description: Run mise tasks in parallel (true) or sequentially (false)
        required: false
        default: false
        type: boolean
    secrets:
      DOCKER_HUB_USERNAME:
      DOCKER_HUB_PASSWORD:
      GH_PAT:

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest

    steps:
      #
      # Checkout source code
      #
      - uses: actions/checkout@v4

      #
      # Setup mise & tools
      #
      - uses: jdx/mise-action@5ac50f778e26fac95da98d50503682459e86d566 # v3.2.0

      #
      # Optional login to Docker Hub
      #
      - name: Login to DockerHub
        if: env.DOCKER_HUB_USERNAME
        uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.5.0
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}
        env:
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}

      #
      # npm: Cache Node.js modules
      #
      - name: Cache Node.js modules
        if: ${{ inputs.variant == 'npm' }}
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Run check task
        # Run mise tasks in parallel or sequentially based on input
        run: |
          if [ "${{ inputs.parallel }}" = "true" ]; then
            mise run ci:check
          else
            mise run --raw ci:check
          fi
        env:
          MISE_ENV: ci
          # required for some builds, set if available
          GH_PAT: ${{ secrets.GH_PAT }}
